`bill-api` - сервис-прослойка между внутренними сервисами (`subscription`) и внешними сервисами оплаты ([Yookassa](https://yookassa.ru/developers/api))

Для запуска можно использовать `compose.dev.yml`
(`compose.yml` использовать не получится из-за закрытых портов; будет использоваться только в составе остальных сервисов):

```sh
docker compose -f compose.dev.yml up --build -d
```

Сервис будет доступен по адресу http://127.0.0.1:8008/api/openapi

PostgreSQL - на порту 5436 (в примерном `.env` логин - `postgres`, пароль - `posgres`, бд - `bill`)

Kafka - на порту 19092 (хост - `localhost`)

Kafka UI - на порту 8081 (хост - `bill-kafka-0`, порт - 9092, так как подключается из docker сети)


## Использование внутренними сервисами
Для опаты, сервису нужно вызывать `/api/v1/payment` и указать:
* `user_id` - пользователя
* `amount`, `currency` - количество валюты
* `return_url` - адрес для возврата со страницы внешнего сервиса оплаты
* (опционально) `handler_url` - URL веб-хука обработчика
* (опционально) `extra_data` - дополнительные данные, передаваемые обработчику

Для возврата, сервису нужно вызывать `/api/v1/payment/{id}/refund` и указать:
* `amount`, `currency` - количество валюты
* (опционально) `handler_url` - URL веб-хука обработчика
* (опционально) `extra_data` - дополнительные данные, передаваемые обработчику

Для полученния результата оплаты/возрата, внутренний сервис использует либо веб-хук, либо считывает kafka топики `payment`/`refund`.

Веб-хук будет вызываться до тех пор, пока не вернет HTTP статус 200.

И веб-хук, и kafka консьюмер должны быть идемпотентными, то есть быть готовыми получить одно и то же сообщение несколько раз.

В обоих случаях уведомление (о результате операции) будет представлено в виде json объекта:
* `id` - оплаты или возврата
* `status` - `succeeded` или `cancelled`
* `external_cancellation_reason` - указан при статусе `cancelled`
* `extra_data` - дополнительные данные, переданные при вызове оплаты/возврата